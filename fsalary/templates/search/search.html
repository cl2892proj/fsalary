{% extends 'base.html' %}
{% load humanize %}
{% load nvd3_tags %}

{% block search_block %}

    <div style="padding-left: 10px; padding-right: 10px;" class="container">

        <h2>Search</h2>

        <!-- start search form -->
        <form method="get" action={% url 'haystack_search' %}>
            {% csrf_token %}
            {{ form.q }}
            <input type="submit" value="Search">
        </form>
        <!--end search form-->

        <!--start left panel-->
        <div class="col-xs-12 col-sm-3">
            {% if query %}

                <button type="button" class="btn btn-primary" onclick="sendFacetURL()">filter</button>

                <!-- Begin Faceting -->
                {% if facets.fields.employer_name %}
                    <h4>Employer Name</h4>

                    <div>
                        {# Provide only the top 5 employer_names #}
                        {% for employer_name in facets.fields.employer_name|slice:":10" %}
                            <div class="checkbox">
                                <label><input type="checkbox" name="employer_name[]" value="{{ employer_name.0 }}">{{ employer_name.0 }} ({{ employer_name.1 }})</label>
                            </div>
                        {% endfor %}
                    </div>
                {% endif %}

                {% if facets.fields.employer_address1 %}
                    <h4>Employer Address</h4>

                    <div>
                        {# Provide only the top 5 addresses #}
                        {% for employer_address1 in facets.fields.employer_address1|slice:":10" %}
                            <div class="checkbox">
                                <label><input type="checkbox" name="employer_address1[]" value="{{ employer_address1.0 }}">{{ employer_address1.0 }} ({{ employer_address1.1 }})</label>
                            </div>
                        {% endfor %}
                    </div>
                {% endif %}
                <!-- End Faceting --> 
            {% endif %}
        </div>
        <!--end left panel-->

        <!--start main panel-->
        <div class="col-xs-12 col-sm-9">
            <div>

                <!-- Nav tabs -->
                <ul class="nav nav-tabs" role="tablist">
                    <li role="presentation" class="active"><a href="#detail" aria-controls="detail" role="tab" data-toggle="tab">Detail View</a></li>
                    <li role="presentation"><a href="#graph" aria-controls="graph" role="tab" data-toggle="tab">Graphic View</a></li>
                </ul>

                <!-- Tab panes -->
                <div class="tab-content">
                    <!--detail pane start-->
                    <div role="tabpanel" class="tab-pane active" id="detail">
                        {% if query %}
                            <h3>{{ page_obj.paginator.count }} Results</h3>

                            <nav>
                                <ul class="pagination">
                                    <!-- previous page  -->
                                    <li {% if not page_obj.has_previous %}class="disabled"{% endif %}>
                                        <a href={% if not page_obj.has_previous %}"#"
                                                {% else %}
                                                    "{{ request.get_full_path }}&page={{ page_obj.previous_page_number }}"
                                                {% endif %}>
                                            <span>&laquo; Previous Page</span>
                                        </a> 
                                    </li>

                                    <!-- page 1 -->
                                    <li {% if page_obj.number == 1 %}class="active" {% endif %}><a href="{{ request.get_full_path }}&page=1">1</a></li>

                                    <!-- first ... -->
                                    {% if first_dotdotdot %}<li class="disabled"><a href="#">...</a></li>{% endif %}

                                    <!-- middle pages -->
                                    {% for i in pages_visible %}
                                    <li {% if page_obj.number == i %}class="active" {% endif %}><a href="{{ request.get_full_path }}&page={{ i }}">{{ i }}</a></li>
                                    {% endfor %}

                                    <!-- second ... -->
                                    {% if last_dotdotdot %}<li class="disabled"><a href="#">...</a></li>{% endif %}

                                    <!-- last page -->
                                    {% if page_obj.paginator.num_pages > 1 %}
                                    <li {% if page_obj.number == page_obj.paginator.num_pages %}class="active" {% endif %}><a href="{{ request.get_full_path }}&page={{ page_obj.paginator.num_pages }}">{{ page_obj.paginator.num_pages }}</a></li>
                                    {% endif %}


                                    <!-- next page -->
                                    <li {% if not page_obj.has_next %}class="disabled"{% endif %}>
                                        <a href={% if not page_obj.has_next %}"#"
                                                {% else %}
                                                    "{{ request.get_full_path }}&page={{ page_obj.next_page_number }}"
                                                {% endif %}>
                                            <span>Next page &raquo;</span>
                                        </a> 
                                    </li>
                                </ul>
                            </nav>

                            <table class="table">
                                {% for result in object_list %}
                                    <tr>
                                        <td>{{ result.object.year }}</td>
                                        <td>{{ result.object.job_title }}</td>
                                        <td>
                                            {%if result.object.wage_rate_of_pay_from %}
                                                {{ result.object.wage_rate_of_pay_from|floatformat:"0"|intcomma }}  
                                            {% else %}
                                                {{ result.object.prevailing_wage|floatformat:"0"|intcomma  }} 
                                            {% endif %} /  
                                            {{ result.object.wage_unit_of_pay }} 
                                        </td>
                                        <td>{{ result.object.employer_name }}</td>
                                        <td>
                                            {{ result.object.employer_address1}}
                                            {%if  result.object.employer_address2 %}
                                                {{ result.object.employer_address2}}
                                            {% endif %}
                                            ,<br>
                                            {{ result.object.employer_city}}, {{ result.object.employer_state}}
                                            {{ result.object.employer_postal_code}}
                                        </td>
                                        <td><a href="{{ result.object.get_absolute_url }}"><p>view</p></a></td>
                                    </tr>
                                {% empty %}
                                    <p>No results found.</p>
                                {% endfor %}

                            </table>

                        {% else %}
                            {# Show some example queries to run, maybe query syntax, something else? #}
                        {% endif %}
                    </div>
                    <!--detail pane ends-->

                    <div role="tabpanel" class="tab-pane" id="graph">
                        {% include_chart_jscss %}
                        {% load_chart charttype chartdata chartcontainer d3_extra %}
                        {% include_container chartcontainer%}
                    </div>
                </div>

            </div>



        </div>
        <!--end main panel-->
    </div>

    <script>
        function sendFacetURL(){
            var facet_arr=["employer_name","employer_address1"];
            var curURL = "{{ request.get_full_path }}";
            var arr = curURL.split("&amp;");
            
            var res = ""
            var facet_set = new Set();
            for(var i in arr){
                if(arr[i].indexOf("page=")==-1){
                    if (res == "") res = arr[i]
                    else res = res+"&"+arr[i];
                    facet_set.add(arr[i]);
                } 
            }

            for(var i=0; i<facet_arr.length; i++){
                var facet_boxes=document.getElementsByName(facet_arr[i]+"[]");
                for(var j=0; j<facet_boxes.length; j++){
                    if(facet_boxes[j].checked){
                        var str ="selected_facets="+facet_arr[i]+"_exact:"+encodeURIComponent(facet_boxes[j].value); 
                        if(!facet_set.has(str)) res=res+"&"+str;
                    }
                }
            }
            window.location=res;
        }
    </script>
{% endblock %}
